<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <title>Expenses Tracker</title>

</head>

<body>

    <div class="container">

        <div class="row">
            <div class="col-md-6">
                <div class="bg-success p-3 text-white">
                    <!-- Form for cell 2 -->
                    <h2>Expenses Tracker</h2>
                    <form>
                        <div class="form-group">
                            <label for="amount">Amount</label>
                            <input type="number" class="form-control" id="amount" name="amount" step="any" required>
                        </div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select class="form-control" id="category" name="category" required>
                                <option value="online-shopping">Online Shopping</option>
                                <option value="bills">Bills</option>
                                <option value="grocery">Grocery</option>
                                <option value="food">Food</option>
                                <option value="transportation">Transportation</option>
                                <option value="other" selected>Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notes">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" class="form-control" id="date" name="date" required>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="necessity" name="necessity" checked>
                            <label class="form-check-label" for="necessity">Necessity</label>
                        </div>
                        <button type="submit" class="btn btn-primary mt-3" onclick="saveExpense()">Add</button>
                    </form>
                </div>
            </div>
            <div class="col-md-6 d-flex align-items-center justify-content-center">
                <div class="text-danger">
                    <h2 id="currentMonthExpensesText"></h2>
                    <div id="totalExpenses" style="font-size: 80px;font-style: italic; color: red;"></div>
                </div>
            </div>
        </div>

        <div class="row bg-light">
            <div class="col-md-6">
                <h4>Monthly Expenses</h4>

                <table class="table">
                    <thead>
                        <tr>
                            <th>Month</th>
                            <th>Expenses</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyExpensesTableBody"></tbody>
                </table>
            </div>

            <!-- Second cell - Pie chart showing expenses by category -->
            <div class="col-md-6">
                <h4>Expenses by Category</h4>
                <canvas id="expensesPieChart"></canvas>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <!-- First cell - Table with month-wise aggregated expenses -->

    </div>
    <!-- Settings button at the bottom of the page -->
    <div class="fixed-bottom text-center p-3">
        <button class="btn btn-primary" data-toggle="modal" data-target="#settingsModal">Settings</button>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-labelledby="settingsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Settings</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-primary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-info" onclick="importData()">Import Data</button>
                    <button class="btn btn-danger" onclick="resetData()">Reset Data</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <!-- Bootstrap JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        // Set the date input to today
        document.getElementById('date').valueAsDate = new Date();

        function saveExpense() {
            // Get form values
            var amount = document.getElementById('amount').value;
            var category = document.getElementById('category').value;
            var notes = document.getElementById('notes').value;
            var date = document.getElementById('date').value;
            var necessity = document.getElementById('necessity').checked;

            // Create an object to represent the expense
            var expense = {
                amount: amount,
                category: category,
                notes: notes,
                date: date,
                necessity: necessity
            };

            // Get existing expenses from localStorage or initialize an empty array
            var expenses = JSON.parse(localStorage.getItem('expenses')) || [];

            // Add the new expense to the array
            expenses.push(expense);

            // Save the updated array back to localStorage
            localStorage.setItem('expenses', JSON.stringify(expenses));

            // Optionally, you can display a message or perform other actions after saving
            alert('Expense saved successfully!');
        }
        // Function to update the total expenses text based on the sum of expenses in the current month
        function updateTotalExpenses() {
            // Get current month and year
            var currentDate = new Date();
            var currentMonth = currentDate.getMonth() + 1; // Months are zero-indexed
            var currentYear = currentDate.getFullYear();

            // Get existing expenses from localStorage or initialize an empty array
            var expenses = JSON.parse(localStorage.getItem('expenses')) || [];

            // Filter expenses for the current month and year
            var currentMonthExpenses = expenses.filter(function (expense) {
                var expenseDate = new Date(expense.date);
                return expenseDate.getMonth() + 1 === currentMonth && expenseDate.getFullYear() === currentYear;
            });

            // Calculate the sum of expenses for the current month
            var sumOfExpenses = currentMonthExpenses.reduce(function (sum, expense) {
                return sum + parseFloat(expense.amount);
            }, 0);

            // Update the total expenses text
            var totalExpensesElement = document.getElementById('totalExpenses');
            if (totalExpensesElement) {
                totalExpensesElement.textContent = sumOfExpenses.toFixed(2);
            } else {
                console.error("Element with ID 'totalExpenses' not found");
            }
        }

        // Call the updateTotalExpenses function initially
        updateTotalExpenses();
        // Function to update the current month expenses text
        function updateCurrentMonthExpensesText() {
            // Get current month and year
            var currentDate = new Date();
            var currentMonth = currentDate.toLocaleString('default', { month: 'long' });

            // Update the current month expenses text
            var currentMonthExpensesText = document.getElementById('currentMonthExpensesText');
            if (currentMonthExpensesText) {
                currentMonthExpensesText.textContent = currentMonth + ' Expenses';
            } else {
                console.error("Element with ID 'currentMonthExpensesText' not found");
            }
        }

        // Call the updateCurrentMonthExpensesText function initially
        updateCurrentMonthExpensesText();
        // Function to export data to CSV
        function exportData() {
            var expenses = JSON.parse(localStorage.getItem('expenses')) || [];
            if (expenses.length === 0) {
                alert('No data to export.');
                return;
            }

            // Create a CSV content
            var csvContent = 'data:text/csv;charset=utf-8,';
            csvContent += 'amount,category,notes,date,necessity\n';

            expenses.forEach(function (expense) {
                csvContent += `${expense.amount},"${expense.category}","${expense.notes}","${expense.date}",${expense.necessity}\n`;
            });

            // Create a link and trigger a download
            var encodedUri = encodeURI(csvContent);
            var link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', 'expenses.csv');
            document.body.appendChild(link);
            link.click();
        }

        // Function to reset data
        function resetData() {
            var confirmReset = confirm('Are you sure you want to reset all data?');
            if (confirmReset) {
                localStorage.removeItem('expenses');
                alert('Data reset successfully.');
            }
        }

        // Function to parse CSV data
        function parseCSV(csv) {
            var lines = csv.split('\n');
            var result = [];

            var headers = lines[0].split(',');

            for (var i = 1; i < lines.length; i++) {
                var data = lines[i].split(',');
                if (data.length === headers.length) {
                    var item = {};
                    for (var j = 0; j < headers.length; j++) {
                        // Remove leading/trailing quotes and unescape escaped quotes
                        var key = headers[j].trim();
                        var value = data[j].trim().replace(/^"(.*)"$/, '$1').replace(/\\"/g, '"');
                        item[key] = value;
                    }
                    result.push(item);
                }
            }

            return result;
        }

        // Function to import data from CSV
        function importData() {
            var fileInput = document.createElement('input');
            fileInput.type = 'file';

            fileInput.addEventListener('change', function () {
                var file = fileInput.files[0];

                if (file) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        try {
                            var importedData = parseCSV(e.target.result);
                            localStorage.setItem('expenses', JSON.stringify(importedData));
                            alert('Data imported successfully.');
                        } catch (error) {
                            alert('Error importing data. Please check the CSV file format.');
                        }
                    };

                    reader.readAsText(file);
                }
            });

            fileInput.click();
        }


        var expenses = JSON.parse(localStorage.getItem('expenses')) || [];

        // Function to generate the monthly expenses table
        function generateMonthlyExpensesTable() {
            var monthlyExpensesTableBody = document.getElementById('monthlyExpensesTableBody');
            var months = {};

            // Populate the months object with aggregated expenses
            expenses.forEach(function (expense) {
                var month = new Date(expense.date).toLocaleString('default', { month: 'long' });
                months[month] = (months[month] || 0) + parseFloat(expense.amount);
            });

            // Clear existing rows
            monthlyExpensesTableBody.innerHTML = '';

            // Add rows to the table
            for (var month in months) {
                var row = document.createElement('tr');
                row.innerHTML = `
        <td>${month}</td>
        <td>${months[month].toFixed(2)}</td>`;
                monthlyExpensesTableBody.appendChild(row);
            }
        }

        // Function to generate the expenses pie chart
        function generateExpensesPieChart() {
            var ctx = document.getElementById('expensesPieChart').getContext('2d');
            var categories = {};

            // Populate the categories object with aggregated expenses
            expenses.forEach(function (expense) {
                categories[expense.category] = (categories[expense.category] || 0) + parseFloat(expense.amount);
            });

            // Generate the pie chart
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(153, 102, 255, 0.7)',
                            'rgba(255, 159, 64, 0.7)',
                        ],
                    }],
                },
            });
        }

        // Function to view expenses for a specific month
        function viewExpenses(month) {
            // You can implement the action to view expenses for the selected month
            alert('Viewing expenses for ' + month);
        }

        // Call the functions initially
        generateMonthlyExpensesTable();
        generateExpensesPieChart();
    </script>
</body>

</html>